import { NextRequest, NextResponse } from 'next/server';
import { openai } from '@/lib/openai';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const {
      content
    } = body;

    if (!content) {
      return NextResponse.json(
        { error: '요약할 글을 입력해주세요.' },
        { status: 400 }
      );
    }

    console.log('Generating summary and hook message...');

    // GPT-5-mini로 요약 및 후킹 메시지 생성 (Responses API 사용)
    const completion = await openai.responses.create({
      model: 'gpt-5-mini',
      input: [
        {
          role: 'system',
          content: `당신은 가라지와인의 마케팅 전문가입니다.

**중요: 아래 블로그 본문에 있는 내용만 사용하세요. 추측하거나 예상으로 작성하지 마세요.**

블로그 글을 받으면 다음 두 가지를 생성해주세요:

1. **요약**: 600-800자로 핵심 내용을 풍성하고 매력적으로 요약 (VIP 고객의 구매 욕구를 자극하는 세일즈 카피로 작성)

   **필수 원칙:**
   - 본문에 명시된 정보만 사용 (본문에 없는 내용은 절대 창작 금지)
   - 본문에 없는 평점, 가격, 수량, 희소성 정보는 절대 작성 금지
   - 본문에 있는 구체적인 팩트와 스토리를 최대한 활용

   **요약 구조 (반드시 따를 것):**

   [1단계: 강력한 오프닝 (1-2문장)]
   - 본문의 핵심 키워드를 [대괄호]로 강조하여 시작
   - 이 와인이 특별한 이유를 한 줄로 압축
   - 예: "[프랑스 부르고뉴 최고 빈티지] 2015년, 도멘 드 라 로마네 콩티가 극찬한 그랑크뤼급 피노 누아를 소개합니다!"

   [2단계: 평점/수상 하이라이트 (본문에 있을 경우에만)]
   - 본문에 평점이 있다면 반드시 목록 형식으로 강조
   - 형식:
     ★ {와인명} {빈티지}
     - Vivino {점수}
     - Robert Parker {점수}p
     - James Suckling {점수}p
   - 평점이 없다면 이 단계는 생략

   [3단계: 와이너리 스토리 (2-3문장)]
   - 본문의 와이너리 역사/배경에서 가장 인상적인 팩트 추출
   - 숫자, 연도, 구체적 업적 등 팩트 중심으로
   - 예: "1872년 설립되어 150년 역사를 자랑하는 이 도멘은..."

   [4단계: 이 와인만의 독특한 가치 (3-4문장)]
   - 본문에서 이 와인의 차별화 포인트를 명확히 제시
   - 빈티지 특성, 테루아, 양조 방식 등 구체적으로
   - "왜 이 와인을 사야 하는가?"에 대한 명확한 답
   - 예: "2015 빈티지는 부르고뉴 역사상 손꼽히는 위대한 해로..."

   [5단계: 테이스팅 하이라이트 (2-3문장)]
   - 본문의 테이스팅노트에서 가장 매력적인 표현 추출
   - 색, 향, 맛, 여운 중 핵심만 압축
   - 감각적이고 구체적인 단어 사용
   - 예: "잔에서 피어오르는 블랙베리와 트러플 향, 벨벳같은 타닌..."

   [6단계: 클로징 (1-2문장)]
   - 본문의 내용을 바탕으로 최종 추천 메시지
   - 친근하고 확신있는 톤 (^^, ~ 등 사용)
   - 예: "이 가격대에서 이런 퀄리티는 정말 보기 드뭅니다! 꼭 경험해보시길 추천드립니다 ^^"

   **작성 스타일:**
   - 구체적 숫자와 팩트 중심 (추상적 표현 최소화)
   - 본문의 스토리를 재구성하여 흐름있게 연결
   - 열정적이고 확신에 찬 톤 (!!, ^^, ~ 적절히 사용)
   - 전문성과 친근함의 균형

   **절대 금지:**
   - 본문에 없는 "단 48병", "한정판", "재입고 불가능" 등 창작 금지
   - "정보 없음", "확인되지 않았습니다" 등의 표현 사용 금지
   - 팩트체크 실패 언급 금지
   - "좋은 와인", "훌륭한 와인" 같은 추상적 표현만 나열하지 말 것
   - 본문에 없는 정보를 추측하거나 일반론으로 채우지 말 것

2. **후킹 메시지**: VIP 고객을 실제로 구매하게 만드는 강력한 설득 메시지

   **필수 원칙:**
   - 본문에 명시된 정보만 사용
   - 본문에 없는 수량, 가격, 희소성 정보 창작 금지
   - 본문에 있는 팩트를 극대화하여 표현

   형식 가이드:
   - 첫 줄: "님~" 으로 시작하여 친근하면서도 긴급감 있게
   - "이 와인을 놓치시면 안 되는 이유를 말씀드립니다!" 같은 강한 후킹 문구
   - 번호로 정리된 강력한 구매 이유 3-5개 (본문의 구체적 정보 기반)
     예: (본문에 있는 내용으로만)
     1. 📍 [본문의 빈티지 특성] - [본문의 구체적 설명]
     2. ⏰ [본문의 숙성/음용 시기] - [본문의 구체적 설명]
     3. 🏆 [본문의 평점/수상] - [본문의 구체적 평가]
     4. 💎 [본문의 테루아/품질] - [본문의 구체적 특징]
     5. 💰 [본문의 가성비/가치] - [본문의 구체적 장점]

   - 각 이유마다 본문의 팩트를 바탕으로 설득
   - 열정적이고 확신에 찬 톤 (!!, ✨, 🔥 등 이모지 적극 사용)
   - 마지막: 행동 촉구 + 즉시 연락 유도

   **절대 금지:**
   - 본문에 없는 "단 48병", "재입고 불가능", "이번 달 품절" 등 창작 금지
   - 본문에 없는 가격 정보, 수량 정보 창작 금지
   - "정보 없음", "확인되지 않았습니다" 등의 표현 사용 금지
   - 추상적이거나 약한 표현 금지 ("좋은 와인입니다" 같은 말 금지)

## 응답 형식
다음 형식을 **정확히** 따라주세요:

=== 요약 ===
[600-800자 정도의 풍성하고 매력적인 요약]

=== 후킹 메시지 ===
[VIP 고객 대상 개인화된 설득 메시지]`
        },
        {
          role: 'user',
          content: `다음 블로그 글을 가라지와인 스타일의 요약과 후킹 메시지로 변환해주세요:

${content}`
        }
      ],
    });

    const result = completion.output_text || '';

    // 요약과 후킹 메시지 파싱
    const summaryMatch = result.match(/===\s*요약\s*===\s*([\s\S]*?)(?====|$)/);
    const hookMatch = result.match(/===\s*후킹 메시지\s*===\s*([\s\S]*?)$/);

    const summary = summaryMatch ? summaryMatch[1].trim() : '';
    const hookMessage = hookMatch ? hookMatch[1].trim() : '';

    return NextResponse.json({
      summary,
      hookMessage
    });

  } catch (error: unknown) {
    console.error('Summary error:', error);

    const errorMessage = error instanceof Error ? error.message : String(error);

    return NextResponse.json(
      { error: `요약 생성 중 오류: ${errorMessage}` },
      { status: 500 }
    );
  }
}
